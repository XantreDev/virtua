{"version":3,"file":"VList-d53f72b7.js","sources":["../../src/react/useRefWithUpdate.ts","../../src/react/VList.tsx"],"sourcesContent":["import { useRef } from \"react\";\nimport { useIsomorphicLayoutEffect } from \"./useIsomorphicLayoutEffect\";\nimport { refKey } from \"./utils\";\n\nexport const useRefWithUpdate = <T>(value: T) => {\n  const ref = useRef<T>(value);\n\n  useIsomorphicLayoutEffect(() => {\n    ref[refKey] = value;\n  }, [value]);\n\n  return ref;\n};\n","import {\n  Children,\n  memo,\n  useRef,\n  useMemo,\n  CSSProperties,\n  ReactElement,\n  forwardRef,\n  useImperativeHandle,\n  ReactNode,\n  useEffect,\n  RefObject,\n  useState,\n  ReactFragment,\n} from \"react\";\nimport { VirtualStore, createVirtualStore } from \"../core/store\";\nimport { useIsomorphicLayoutEffect } from \"./useIsomorphicLayoutEffect\";\nimport { useSyncExternalStore } from \"./useSyncExternalStore\";\nimport { exists, max, min } from \"../core/utils\";\nimport { createScroller } from \"../core/scroller\";\nimport { isInvalidElement, refKey } from \"./utils\";\nimport { useStatic } from \"./useStatic\";\nimport { useRefWithUpdate } from \"./useRefWithUpdate\";\nimport { Resizer, createResizer } from \"../core/resizer\";\nimport { WindowComponentAttributes } from \"..\";\n\ntype ItemProps = {\n  _children: ReactNode;\n  _resizer: Resizer;\n  _store: VirtualStore;\n  _index: number;\n  _element: \"div\";\n  _isHorizontal: boolean;\n  _isRtl: boolean;\n};\n\nconst Item = memo(\n  ({\n    _children: children,\n    _resizer: resizer,\n    _store: store,\n    _index: index,\n    _element: Element,\n    _isHorizontal: isHorizontal,\n    _isRtl: isRtl,\n  }: ItemProps): ReactElement => {\n    const ref = useRef<HTMLDivElement>(null);\n\n    const offset = useSyncExternalStore(store._subscribe, () =>\n      store._getItemOffset(index)\n    );\n    const hide = useSyncExternalStore(store._subscribe, () =>\n      store._isUnmeasuredItem(index)\n    );\n\n    // The index may be changed if elements are inserted to or removed from the start of props.children\n    useIsomorphicLayoutEffect(\n      () => resizer._observeItem(ref[refKey]!, index),\n      [index]\n    );\n\n    return (\n      <Element\n        ref={ref}\n        style={useMemo((): CSSProperties => {\n          const leftOrRightKey = isRtl ? \"right\" : \"left\";\n          const style: CSSProperties = {\n            margin: 0,\n            padding: 0,\n            position: \"absolute\",\n            [isHorizontal ? \"height\" : \"width\"]: \"100%\",\n            [isHorizontal ? \"top\" : leftOrRightKey]: 0,\n            [isHorizontal ? leftOrRightKey : \"top\"]: offset,\n            visibility: hide ? \"hidden\" : \"visible\",\n            // willChange: \"transform\",\n          };\n          if (isHorizontal) {\n            style.display = \"flex\";\n          }\n          return style;\n        }, [offset, hide])}\n      >\n        {children}\n      </Element>\n    );\n  }\n);\n\n/**\n * Props of customized scrollable component for {@link VList}.\n */\nexport interface CustomWindowComponentProps {\n  children: ReactNode;\n  scrollSize: number;\n  scrolling: boolean;\n  horizontal: boolean;\n  attrs: WindowComponentAttributes;\n}\n\nconst DefaultWindow = forwardRef<any, CustomWindowComponentProps>(\n  (\n    { children, scrollSize, scrolling, horizontal, attrs },\n    ref\n  ): ReactElement => {\n    return (\n      <div ref={ref} {...attrs}>\n        <div\n          style={useMemo((): CSSProperties => {\n            return {\n              position: \"relative\",\n              visibility: \"hidden\",\n              width: horizontal ? scrollSize : \"100%\",\n              height: horizontal ? \"100%\" : scrollSize,\n              pointerEvents: scrolling ? \"none\" : \"auto\",\n            };\n          }, [scrollSize, scrolling])}\n        >\n          {children}\n        </div>\n      </div>\n    );\n  }\n);\n\nexport type CustomWindowComponent = typeof DefaultWindow;\n\nconst Window = ({\n  _children: children,\n  _ref: ref,\n  _store: store,\n  _element: Element,\n  _scrolling: scrolling,\n  _attrs: attrs,\n  _isHorizontal: horizontal,\n}: {\n  _children: ReactNode;\n  _ref: RefObject<HTMLDivElement>;\n  _store: VirtualStore;\n  _element: CustomWindowComponent;\n  _scrolling: boolean;\n  _attrs: WindowComponentAttributes;\n  _isHorizontal: boolean;\n}) => {\n  const scrollSize = useSyncExternalStore(\n    store._subscribe,\n    store._getScrollSize\n  );\n\n  return (\n    <Element\n      ref={ref}\n      scrollSize={scrollSize}\n      scrolling={scrolling}\n      horizontal={horizontal}\n      attrs={useMemo(\n        () => ({\n          ...attrs,\n          style: {\n            overflow: horizontal ? \"auto hidden\" : \"hidden auto\",\n            contain: \"strict\",\n            // transform: \"translate3d(0px, 0px, 0px)\",\n            // willChange: \"scroll-position\",\n            // backfaceVisibility: \"hidden\",\n            width: \"100%\",\n            height: \"100%\",\n            padding: 0,\n            margin: 0,\n            ...attrs.style,\n          },\n        }),\n        [attrs]\n      )}\n    >\n      {children}\n    </Element>\n  );\n};\n\n/**\n * Props of customized item component for {@link VList}.\n */\nexport interface CustomItemComponentProps {\n  style: CSSProperties;\n  children: ReactNode;\n}\n\nexport type CustomItemComponent = React.ForwardRefExoticComponent<\n  React.PropsWithoutRef<CustomItemComponentProps> & React.RefAttributes<any>\n>;\n\ntype CustomItemComponentOrElement =\n  | keyof JSX.IntrinsicElements\n  | CustomItemComponent;\n\n/**\n * Methods of {@link VList}.\n */\nexport interface VListHandle {\n  /**\n   * Get current scrollTop or scrollLeft.\n   */\n  readonly scrollOffset: number;\n  /**\n   * Get current scrollHeight or scrollWidth.\n   */\n  readonly scrollSize: number;\n  /**\n   * Get current offsetHeight or offsetWidth.\n   */\n  readonly viewportSize: number;\n  /**\n   * Scroll to the item specified by index.\n   * @param index index of item\n   */\n  scrollToIndex(index: number): void;\n  /**\n   * Scroll to the given offset.\n   * @param offset offset from start\n   */\n  scrollTo(offset: number): void;\n  /**\n   * Scroll by the given offset.\n   * @param offset offset from current position\n   */\n  scrollBy(offset: number): void;\n}\n\n/**\n * Props of {@link VList}.\n */\nexport interface VListProps extends WindowComponentAttributes {\n  /**\n   * Elements rendered by this component.\n   */\n  children: ReactNode;\n  /**\n   * Item size hint for unmeasured items. It's recommended to specify this prop if item sizes are fixed and known, or much larger than the defaultValue. It will help to reduce scroll jump when items are measured.\n   * @defaultValue 40\n   */\n  itemSize?: number;\n  /**\n   * Number of items to render above/below the visible bounds of the list. You can increase to avoid showing blank items in fast scrolling.\n   * @defaultValue 4\n   */\n  overscan?: number;\n  /**\n   * If set, the specified amount of items will be mounted in the initial rendering regardless of the container size. This prop is mostly for SSR.\n   */\n  initialItemCount?: number;\n  /**\n   * If true, rendered as a horizontally scrollable list. Otherwise rendered as a vertically scrollable list.\n   */\n  horizontal?: boolean;\n  /**\n   * You have to set true if you use this component under `direction: rtl` style.\n   */\n  rtl?: boolean;\n  /**\n   * Customized element type for scrollable element. This element will get {@link CustomWindowComponentProps} as props.\n   * @defaultValue {@link DefaultWindow}\n   */\n  element?: CustomWindowComponent;\n  /**\n   * Customized element type for item element. This element will get {@link CustomItemComponentProps} as props.\n   * @defaultValue \"div\"\n   */\n  itemElement?: CustomItemComponentOrElement;\n  /**\n   * Callback invoked whenever scroll offset changes.\n   * @param offset Current scrollTop or scrollLeft.\n   */\n  onScroll?: (offset: number) => void;\n  /**\n   * Callback invoked when scrolling stops.\n   */\n  onScrollStop?: () => void;\n  /**\n   * Callback invoked when visible items range changes.\n   */\n  onRangeChange?: (payload: {\n    /**\n     * The start index of viewable items.\n     */\n    start: number;\n    /**\n     * The end index of viewable items.\n     */\n    end: number;\n    /**\n     * The total count of items.\n     */\n    count: number;\n  }) => void;\n}\n\n/**\n * Virtualized list component. See {@link VListProps} and {@link VListHandle}.\n */\nexport const VList = forwardRef<VListHandle, VListProps>(\n  (\n    {\n      children,\n      itemSize: itemSizeProp = 40,\n      overscan = 4,\n      initialItemCount,\n      horizontal: horizontalProp,\n      rtl: rtlProp,\n      element = DefaultWindow,\n      itemElement = \"div\",\n      onScroll: onScrollProp,\n      onScrollStop: onScrollStopProp,\n      onRangeChange: onRangeChangeProp,\n      ...windowAttrs\n    },\n    ref\n  ): ReactElement => {\n    // Memoize element array\n    const elements = useMemo(() => {\n      const arr: (ReactElement | ReactFragment | string | number)[] = [];\n      Children.forEach(children, (e) => {\n        if (isInvalidElement(e)) {\n          return;\n        }\n        arr.push(e);\n      });\n      return arr;\n    }, [children]);\n    const count = elements.length;\n\n    const onScroll = useRefWithUpdate(onScrollProp);\n    const onScrollStop = useRefWithUpdate(onScrollStopProp);\n\n    const [mountedIndexes, reset] = useState<Set<number>>(new Set<number>());\n    const [scrolling, setScrolling] = useState(false);\n    const [store, resizer, scroller, isHorizontal, isRtl] = useStatic(() => {\n      const _isHorizontal = !!horizontalProp;\n      const _isRtl = !!rtlProp;\n      const _store = createVirtualStore(\n        count,\n        itemSizeProp,\n        initialItemCount,\n        (isScrolling) => {\n          setScrolling(isScrolling);\n          if (!isScrolling) {\n            reset(new Set());\n            onScrollStop[refKey] && onScrollStop[refKey]();\n          }\n        },\n        (offset) => {\n          onScroll[refKey] && onScroll[refKey](offset);\n        }\n      );\n\n      const _resizer = createResizer(_store, _isHorizontal);\n      return [\n        _store,\n        _resizer,\n        createScroller(_store, _isHorizontal, _isRtl, _resizer._isJustResized),\n        _isHorizontal,\n        _isRtl,\n      ];\n    });\n    // The elements length and cached items length are different just after element is added/removed.\n    store._updateCacheLength(count);\n\n    const [startIndex, endIndex] = useSyncExternalStore(\n      store._subscribe,\n      store._getRange\n    );\n    const jump = useSyncExternalStore(store._subscribe, store._getJump);\n    const rootRef = useRef<HTMLDivElement>(null);\n\n    useIsomorphicLayoutEffect(() => {\n      const root = rootRef[refKey]!;\n      const unobserve = resizer._observeRoot(root);\n      const cleanup = scroller._initRoot(root);\n      return () => {\n        unobserve();\n        cleanup();\n      };\n    }, []);\n\n    useIsomorphicLayoutEffect(() => {\n      if (!jump.length) return;\n\n      scroller._fixScrollJump(jump, startIndex);\n    }, [jump]);\n\n    useEffect(() => {\n      if (!onRangeChangeProp) return;\n\n      onRangeChangeProp({\n        start: startIndex,\n        end: endIndex,\n        count,\n      });\n    }, [startIndex, endIndex]);\n\n    useImperativeHandle(\n      ref,\n      () => {\n        return {\n          get scrollOffset() {\n            return store._getScrollOffset();\n          },\n          get scrollSize() {\n            return scroller._getActualScrollSize();\n          },\n          get viewportSize() {\n            return store._getViewportSize();\n          },\n          scrollToIndex(index) {\n            scroller._scrollToIndex(index, count);\n          },\n          scrollTo: scroller._scrollTo,\n          scrollBy(offset) {\n            scroller._scrollTo(store._getScrollOffset() + offset);\n          },\n        };\n      },\n      [count]\n    );\n\n    const startIndexWithMargin = max(startIndex - overscan, 0);\n    const endIndexWithMargin = min(endIndex + overscan, count - 1);\n    const items = useMemo(() => {\n      const res: ReactElement[] = [];\n      for (let i = startIndexWithMargin; i <= endIndexWithMargin; i++) {\n        // https://github.com/sergi/virtual-list/commit/8e7e06dc63568334c1ab809ea83c1be36572e9ed\n        mountedIndexes.add(i);\n      }\n      mountedIndexes.forEach((i) => {\n        const e = elements[i];\n        // This can be undefined when items are removed\n        if (exists(e)) {\n          res.push(\n            <Item\n              key={(e as { key?: ReactElement[\"key\"] })?.key || i}\n              _resizer={resizer}\n              _store={store}\n              _index={i}\n              _element={itemElement as \"div\"}\n              _children={e}\n              _isHorizontal={isHorizontal}\n              _isRtl={isRtl}\n            />\n          );\n        }\n      });\n      return res;\n    }, [elements, mountedIndexes, startIndexWithMargin, endIndexWithMargin]);\n\n    return (\n      <Window\n        _ref={rootRef}\n        _store={store}\n        _element={element}\n        _scrolling={scrolling}\n        _children={items}\n        _attrs={windowAttrs}\n        _isHorizontal={isHorizontal}\n      />\n    );\n  }\n);\n"],"names":["useRefWithUpdate","value","ref","useRef","useIsomorphicLayoutEffect","refKey","Item","memo","children","resizer","store","index","Element","isHorizontal","isRtl","offset","useSyncExternalStore","hide","jsx","useMemo","leftOrRightKey","style","DefaultWindow","forwardRef","scrollSize","scrolling","horizontal","attrs","Window","VList","itemSizeProp","overscan","initialItemCount","horizontalProp","rtlProp","element","itemElement","onScrollProp","onScrollStopProp","onRangeChangeProp","windowAttrs","elements","arr","Children","e","isInvalidElement","count","onScroll","onScrollStop","mountedIndexes","reset","useState","setScrolling","scroller","useStatic","_isHorizontal","_isRtl","_store","createVirtualStore","isScrolling","_resizer","createResizer","createScroller","startIndex","endIndex","jump","rootRef","root","unobserve","cleanup","useEffect","useImperativeHandle","startIndexWithMargin","max","endIndexWithMargin","min","items","res","i","exists"],"mappings":"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"}