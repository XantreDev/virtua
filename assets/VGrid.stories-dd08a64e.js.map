{"version":3,"file":"VGrid.stories-dd08a64e.js","sources":["../../src/react/VGrid.tsx"],"sourcesContent":["import {\n  memo,\n  useRef,\n  useMemo,\n  CSSProperties,\n  ReactElement,\n  forwardRef,\n  ReactNode,\n  RefObject,\n  useState,\n} from \"react\";\nimport { VirtualStore, createVirtualStore } from \"../core/store\";\nimport { useIsomorphicLayoutEffect } from \"./useIsomorphicLayoutEffect\";\nimport { useSyncExternalStore } from \"./useSyncExternalStore\";\nimport { max, min } from \"../core/utils\";\nimport { createScroller } from \"../core/scroller\";\nimport { refKey } from \"./utils\";\nimport { useStatic } from \"./useStatic\";\nimport { WindowComponentAttributes } from \"..\";\nimport { createGridResizer, GridResizer } from \"../core/resizer\";\n\nconst genKey = (i: number, j: number) => `${i}-${j}`;\n\n/**\n * Props of customized cell component for {@link VGrid}.\n */\nexport interface CustomCellComponentProps {\n  style: CSSProperties;\n  children: ReactNode;\n}\n\nexport type CustomCellComponent = React.ForwardRefExoticComponent<\n  React.PropsWithoutRef<CustomCellComponentProps> & React.RefAttributes<any>\n>;\n\ntype CustomCellComponentOrElement =\n  | keyof JSX.IntrinsicElements\n  | CustomCellComponent;\n\ntype CellProps = {\n  _children: ReactNode;\n  _resizer: GridResizer;\n  _verticalStore: VirtualStore;\n  _horizontalStore: VirtualStore;\n  _rowIndex: number;\n  _colIndex: number;\n  _element: \"div\";\n  _isRtl: boolean;\n};\n\nconst Cell = memo(\n  ({\n    _children: children,\n    _resizer: resizer,\n    _verticalStore: verticalStore,\n    _horizontalStore: horizontalStore,\n    _rowIndex: rowIndex,\n    _colIndex: colIndex,\n    _element: Element,\n    _isRtl: isRtl,\n  }: CellProps): ReactElement => {\n    const ref = useRef<HTMLDivElement>(null);\n\n    const top = useSyncExternalStore(verticalStore._subscribe, () =>\n      verticalStore._getItemOffset(rowIndex)\n    );\n    const left = useSyncExternalStore(horizontalStore._subscribe, () =>\n      horizontalStore._getItemOffset(colIndex)\n    );\n    const vHide = useSyncExternalStore(verticalStore._subscribe, () =>\n      verticalStore._isUnmeasuredItem(rowIndex)\n    );\n    const hHide = useSyncExternalStore(horizontalStore._subscribe, () =>\n      horizontalStore._isUnmeasuredItem(colIndex)\n    );\n    const height = useSyncExternalStore(verticalStore._subscribe, () =>\n      verticalStore._getItemSize(rowIndex)\n    );\n    const width = useSyncExternalStore(horizontalStore._subscribe, () =>\n      horizontalStore._getItemSize(colIndex)\n    );\n\n    // The index may be changed if elements are inserted to or removed from the start of props.children\n    useIsomorphicLayoutEffect(\n      () => resizer._observeItem(ref[refKey]!, rowIndex, colIndex),\n      [colIndex, rowIndex]\n    );\n\n    return (\n      <Element\n        ref={ref}\n        style={useMemo((): CSSProperties => {\n          const style: CSSProperties = {\n            display: \"grid\",\n            margin: 0,\n            padding: 0,\n            position: \"absolute\",\n            top: top,\n            [isRtl ? \"right\" : \"left\"]: left,\n            visibility: vHide || hHide ? \"hidden\" : \"visible\",\n            minHeight: height,\n            minWidth: width,\n          };\n          return style;\n        }, [top, left, width, height, vHide, hHide])}\n      >\n        {children}\n      </Element>\n    );\n  }\n);\n\n/**\n * Props of customized scrollable component for {@link VGrid}.\n */\nexport interface CustomGridWindowComponentProps {\n  children: ReactNode;\n  scrollWidth: number;\n  scrollHeight: number;\n  scrolling: boolean;\n  attrs: WindowComponentAttributes;\n}\n\nconst DefaultWindow = forwardRef<any, CustomGridWindowComponentProps>(\n  (\n    { children, scrollWidth, scrollHeight, scrolling, attrs },\n    ref\n  ): ReactElement => {\n    return (\n      <div ref={ref} {...attrs}>\n        <div\n          style={useMemo((): CSSProperties => {\n            return {\n              position: \"relative\",\n              visibility: \"hidden\",\n              width: scrollWidth,\n              height: scrollHeight,\n              pointerEvents: scrolling ? \"none\" : \"auto\",\n            };\n          }, [scrollWidth, scrollHeight, scrolling])}\n        >\n          {children}\n        </div>\n      </div>\n    );\n  }\n);\n\nexport type CustomGridWindowComponent = typeof DefaultWindow;\n\nconst Window = ({\n  _children: children,\n  _ref: ref,\n  _vStore: vStore,\n  _hStore: hStore,\n  _element: Element,\n  _scrolling: scrolling,\n  _attrs: attrs,\n}: {\n  _children: ReactNode;\n  _ref: RefObject<HTMLDivElement>;\n  _vStore: VirtualStore;\n  _hStore: VirtualStore;\n  _element: CustomGridWindowComponent;\n  _scrolling: boolean;\n  _attrs: WindowComponentAttributes;\n}) => {\n  const height = useSyncExternalStore(vStore._subscribe, vStore._getScrollSize);\n  const width = useSyncExternalStore(hStore._subscribe, hStore._getScrollSize);\n\n  return (\n    <Element\n      ref={ref}\n      scrollWidth={width}\n      scrollHeight={height}\n      scrolling={scrolling}\n      attrs={useMemo(\n        () => ({\n          ...attrs,\n          style: {\n            overflow: \"auto\",\n            contain: \"strict\",\n            // transform: \"translate3d(0px, 0px, 0px)\",\n            // willChange: \"scroll-position\",\n            // backfaceVisibility: \"hidden\",\n            width: \"100%\",\n            height: \"100%\",\n            padding: 0,\n            margin: 0,\n            ...attrs.style,\n          },\n        }),\n        [attrs]\n      )}\n    >\n      {children}\n    </Element>\n  );\n};\n\n/**\n * Methods of {@link VGrid}.\n */\nexport interface VGridHandle {}\n\n/**\n * Props of {@link VGrid}.\n */\nexport interface VGridProps extends WindowComponentAttributes {\n  /**\n   * A function to create elements rendered by this component.\n   */\n  children: (arg: {\n    /**\n     * row index of cell\n     */\n    rowIndex: number;\n    /**\n     * column index of cell\n     */\n    colIndex: number;\n  }) => ReactNode;\n  /**\n   * Total row length of grid.\n   */\n  row: number;\n  /**\n   * Total column length of grid.\n   */\n  col: number;\n  /**\n   * Cell height hint for unmeasured items. It's recommended to specify this prop if item sizes are fixed and known, or much larger than the defaultValue. It will help to reduce scroll jump when items are measured.\n   * @defaultValue 40\n   */\n  cellHeight?: number;\n  /**\n   * Cell width hint for unmeasured items. It's recommended to specify this prop if item sizes are fixed and known, or much larger than the defaultValue. It will help to reduce scroll jump when items are measured.\n   * @defaultValue 100\n   */\n  cellWidth?: number;\n  /**\n   * Number of items to render above/below the visible bounds of the grid. You can increase to avoid showing blank items in fast scrolling.\n   * @defaultValue 2\n   */\n  overscan?: number;\n  /**\n   * If set, the specified amount of rows will be mounted in the initial rendering regardless of the container size. This prop is mostly for SSR.\n   */\n  initialRowCount?: number;\n  /**\n   * If set, the specified amount of cols will be mounted in the initial rendering regardless of the container size. This prop is mostly for SSR.\n   */\n  initialColCount?: number;\n  /**\n   * You have to set true if you use this component under `direction: rtl` style.\n   */\n  rtl?: boolean;\n  /**\n   * Customized element type for scrollable element. This element will get {@link CustomGridWindowComponentProps} as props.\n   * @defaultValue {@link DefaultWindow}\n   */\n  element?: CustomGridWindowComponent;\n  /**\n   * Customized element type for cell element. This element will get {@link CustomCellComponentProps} as props.\n   * @defaultValue \"div\"\n   */\n  cellElement?: CustomCellComponentOrElement;\n}\n\n/**\n * Virtualized grid component. See {@link VGridProps} and {@link VGridHandle}.\n */\nexport const VGrid = forwardRef<VGridHandle, VGridProps>(\n  (\n    {\n      children,\n      row: rowCount,\n      col: colCount,\n      cellHeight = 40,\n      cellWidth = 100,\n      overscan = 2,\n      initialRowCount,\n      initialColCount,\n      rtl: rtlProp,\n      element = DefaultWindow,\n      cellElement: itemElement = \"div\",\n      ...windowAttrs\n    },\n    _ref // TODO implement\n  ): ReactElement => {\n    const [verticalScrolling, setVerticalScrolling] = useState(false);\n    const [horizontalScrolling, setHorizontalScrolling] = useState(false);\n    const [vStore, hStore, resizer, vScroller, hScroller, isRtl] = useStatic(\n      () => {\n        const _isRtl = !!rtlProp;\n        const dummy = () => {};\n        const _vs = createVirtualStore(\n          rowCount,\n          cellHeight,\n          initialRowCount,\n          false,\n          setVerticalScrolling,\n          dummy\n        );\n        const _hs = createVirtualStore(\n          colCount,\n          cellWidth,\n          initialColCount,\n          false,\n          setHorizontalScrolling,\n          dummy\n        );\n        const resizer = createGridResizer(_vs, _hs);\n        return [\n          _vs,\n          _hs,\n          resizer,\n          createScroller(_vs, false, _isRtl, () => resizer._isJustResized()),\n          createScroller(_hs, true, _isRtl, () => resizer._isJustResized(true)),\n          _isRtl,\n        ];\n      }\n    );\n    // The elements length and cached items length are different just after element is added/removed.\n    vStore._updateCacheLength(rowCount);\n    hStore._updateCacheLength(colCount);\n\n    const [startRowIndex, endRowIndex] = useSyncExternalStore(\n      vStore._subscribe,\n      vStore._getRange\n    );\n    const [startColIndex, endColIndex] = useSyncExternalStore(\n      hStore._subscribe,\n      hStore._getRange\n    );\n    const verticalJump = useSyncExternalStore(\n      vStore._subscribe,\n      vStore._getJump\n    );\n    const horizontalJump = useSyncExternalStore(\n      hStore._subscribe,\n      hStore._getJump\n    );\n    const rootRef = useRef<HTMLDivElement>(null);\n\n    useIsomorphicLayoutEffect(() => {\n      const root = rootRef[refKey]!;\n      const unobserve = resizer._observeRoot(root);\n      const vCleanup = vScroller._initRoot(root);\n      const hCleanup = hScroller._initRoot(root);\n      return () => {\n        unobserve();\n        vCleanup();\n        hCleanup();\n      };\n    }, []);\n\n    useIsomorphicLayoutEffect(() => {\n      if (verticalJump.length) {\n        vScroller._fixScrollJump(verticalJump, startRowIndex);\n      }\n    }, [verticalJump]);\n    useIsomorphicLayoutEffect(() => {\n      if (horizontalJump.length) {\n        hScroller._fixScrollJump(horizontalJump, startColIndex);\n      }\n    }, [horizontalJump]);\n\n    const render = useMemo(() => {\n      const cache = new Map<string, ReactNode>();\n      return (rowIndex: number, colIndex: number) => {\n        let e: ReactNode | undefined = cache.get(genKey(rowIndex, colIndex));\n        if (!e) {\n          cache.set(\n            genKey(rowIndex, colIndex),\n            (e = children({ rowIndex, colIndex }))\n          );\n        }\n        return e;\n      };\n    }, [children]);\n\n    const startRowIndexWithMargin = max(startRowIndex - overscan, 0);\n    const endRowIndexWithMargin = min(endRowIndex + overscan, rowCount - 1);\n    const startColIndexWithMargin = max(startColIndex - overscan, 0);\n    const endColIndexWithMargin = min(endColIndex + overscan, colCount - 1);\n    const items = useMemo(() => {\n      const res: ReactElement[] = [];\n      for (let i = startRowIndexWithMargin; i <= endRowIndexWithMargin; i++) {\n        for (let j = startColIndexWithMargin; j <= endColIndexWithMargin; j++) {\n          res.push(\n            <Cell\n              key={genKey(i, j)}\n              _resizer={resizer}\n              _verticalStore={vStore}\n              _horizontalStore={hStore}\n              _rowIndex={i}\n              _colIndex={j}\n              _element={itemElement as \"div\"}\n              _children={render(i, j)}\n              _isRtl={isRtl}\n            />\n          );\n        }\n      }\n\n      return res;\n    }, [\n      render,\n      startRowIndexWithMargin,\n      endRowIndexWithMargin,\n      startColIndexWithMargin,\n      endColIndexWithMargin,\n    ]);\n\n    return (\n      <Window\n        _ref={rootRef}\n        _vStore={vStore}\n        _hStore={hStore}\n        _element={element}\n        _scrolling={verticalScrolling || horizontalScrolling}\n        _children={items}\n        _attrs={windowAttrs}\n      />\n    );\n  }\n);\n"],"names":["genKey","i","j","Cell","memo","children","resizer","verticalStore","horizontalStore","rowIndex","colIndex","Element","isRtl","ref","useRef","top","useSyncExternalStore","left","vHide","hHide","height","width","useIsomorphicLayoutEffect","refKey","jsx","useMemo","DefaultWindow","forwardRef","scrollWidth","scrollHeight","scrolling","attrs","Window","vStore","hStore","VGrid","rowCount","colCount","cellHeight","cellWidth","overscan","initialRowCount","initialColCount","rtlProp","element","itemElement","windowAttrs","_ref","verticalScrolling","setVerticalScrolling","useState","horizontalScrolling","setHorizontalScrolling","vScroller","hScroller","useStatic","_isRtl","dummy","_vs","createVirtualStore","_hs","resizer2","createGridResizer","createScroller","startRowIndex","endRowIndex","startColIndex","endColIndex","verticalJump","horizontalJump","rootRef","root","unobserve","vCleanup","hCleanup","render","cache","e","startRowIndexWithMargin","max","endRowIndexWithMargin","min","startColIndexWithMargin","endColIndexWithMargin","items","res"],"mappings":"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"}